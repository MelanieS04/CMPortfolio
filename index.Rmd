---
title: "Computational Musicology"
auhor: "Melanie Stahlecker"
date: "February/March 2020"
output: 
      flexdashboard::flex_dashboard:
       storyboard: true
       theme: flatly 
---

```{r setup, include=FALSE}
library(tidyverse)
library(plotly)
library(compmus)
library(spotifyr)
source('spotify.R')
```

-----------------------------------------------------------------------

### Timbre Cepstrogram of the biggest outlier

```{r}
YBIAW <- 
    get_tidy_audio_analysis('7vFv0yFGMJW3qVXbAd9BK9') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'rms'))

YBIAW %>% 
    compmus_gather_timbre %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = basis, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    scale_fill_viridis_c(option = 'E') +
    theme_classic()

```

***

This is a timbre cepstrogram of the biggest outlier, which is the track Your Body Is a Wonderland on the album Room For Squares. The magnitude seems to be the highest for the two lowest bars. 

-----------------------------------------------------------------------

### Chromagram of Your Body Is a Wonderland

```{r}
YBIAW <- 
  get_tidy_audio_analysis('7vFv0yFGMJW3qVXbAd9BK9') %>% 
  select(segments) %>% unnest(segments) %>% 
  select(start, duration, pitches)
YBIAW %>% 
  mutate(pitches = map(pitches, compmus_normalise, 'euclidean')) %>% 
    compmus_gather_chroma %>% 
    ggplot(
        aes(
            x = start + duration / 2, 
            width = duration, 
            y = pitch_class, 
            fill = value)) + 
    geom_tile() +
    labs(x = 'Time (s)', y = NULL, fill = 'Magnitude') +
    scale_fill_viridis_c(option = 'E') +
    theme_classic()
```

***
This is a chromagram of Your Body Is a Wonderland, the most popular track (with a track popularity of 76) out of all John Mayer albums. It shows that the song is in the key of F-major. The chords C and F are often played in this song, which can also be seen in this chromagram. Something else that can be noticed is that a small part of D shows more magnitude. This part is the bridge, where the D-minor chord is played, which can clearly be seen in the chromagram.

-----------------------------------------------------------------------

### Your Body Is a Wonderland Self-Similarity Matrix

```{r}
YBIAW <- 
    get_tidy_audio_analysis('7vFv0yFGMJW3qVXbAd9BK9') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'mean', norm = 'manhattan')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'rms'))
YBIAW %>% 
    compmus_self_similarity(timbre, 'euclidean') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '')
```

***

This is a self-similarity matrix of Your Body Is a Wonderland. It shows one clear diagonal line. This line indicates the music in time. The next noticeable element are the two more yellow (horizontal and vertical) lines which form some kind of window pane. This indicates that something unexpected happens at this point in time. This means that the overall sound changes a lot. The last element is actually not very noticeable. This element is the homogeneity and this should show different segments in the song that sound similar. 

-----------------------------------------------------------------------

### Slow Dancing in a Burning Room Self-Similarity Matrix

```{r}
SDIABR <- 
    get_tidy_audio_analysis('2jdAk8ATWIL3dwT47XpRfu') %>% 
    compmus_align(bars, segments) %>% 
    select(bars) %>% unnest(bars) %>% 
    mutate(
        pitches = 
            map(segments, 
                compmus_summarise, pitches, 
                method = 'rms', norm = 'euclidean')) %>% 
    mutate(
        timbre = 
            map(segments, 
                compmus_summarise, timbre, 
                method = 'mean'))
SDIABR %>% 
    compmus_self_similarity(timbre, 'cosine') %>% 
    ggplot(
        aes(
            x = xstart + xduration / 2, 
            width = xduration,
            y = ystart + yduration / 2,
            height = yduration,
            fill = d)) + 
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(option = 'E', guide = 'none') +
    theme_classic() +
    labs(x = '', y = '')
```

***
This is another self-similarity matrix. This self-similarity matrix shows the second most popular track, which is "Slow Dancing in a Burning Room" (from the album "Continuum"). The biggest difference between the self-similarity matrix of Your Body Is a Wonderland and the self-similarity matrix of Slow Dancing in a Burning Room is that the change of sound (possibly the bridge) takes place earlier in Slow Dancing in a Burning Room.

-----------------------------------------------------------------------

### Comparing of old and new John Mayer albums

For this corpus idea, I wanted to compare the older John Mayer albums to the newer John Mayer albums. The first thing I did here was compare only the first and last album to see what kind of differences I could find here, especially in the popularity and the valence of the tracks. The next step was to make a scatterplot that easily shows these differences. I finally made this into an interactive scatterplot to be able to show more of the information and to show which song is which. However, this scatterplot would only show two of the total of seven albums. So, my next step was to include all of the albums and make good visuals to show as much information as possible of every album. The first visual is a boxplot. I made boxplots of every album and put them next to each other to be able to compare all of them. What I compared here is only the track popularity. Since this would not be enough information, I also made a scatterplot. This scatterplot would show the albums in different colors, the energy, the valence, and of course the track popularity. My goal here is to try and find out if the older or newer albums of John Mayer are more popular, and if so, why these would be more popular. With all of the information and the visuals, I hope to find an answer to these questions.

***

So, I will use boxplots and interactive scatterplots to try to find more information about the track popularity, the valence, the energy, the mode, and the loudness of John Mayer's albums. With this information I hope to find an answer to whether the older or newer albums are more popular and why.



-----------------------------------------------------------------------

### The Search for Everything is more popular than Room For Squares

```{r}
RoomForSquares <- get_playlist_audio_features('RoomForSquares', '5KTfoZbvQXBqDOn1gp2o3m')
TheSearchForEverything <- get_playlist_audio_features('TheSearchForEverything', '1y61rCSfD47QmYV3m6xKxA')

RFS_TSFE <-
    RoomForSquares %>% mutate(playlist = "Room For Squares") %>%
    bind_rows(TheSearchForEverything %>% mutate(playlist = "The Search For Everything"))
popularity <-
    RFS_TSFE %>%                   
    mutate(                      
        mode =                  
            factor(
                mode, 
                c(1, 0), 
                c("Major", "Minor")
            )
    ) %>% 
    ggplot(                      
        aes(
            x = valence,
            y = track.popularity,
            size = loudness,
            colour = mode,
            label = track.name  
        )
    ) +
    geom_point() +               
    geom_rug(size = 0.1) +       
    facet_wrap(~ playlist) +     
    scale_x_continuous(          
        limits = c(0, 1),
        breaks = c(0, 0.25, 0.50, 0.75, 1),  
        minor_breaks = NULL      
    ) +
    scale_y_continuous(          
        limits = c(40, 80),
        breaks = c(40, 45, 50, 55, 60, 65, 70, 75, 80),
        minor_breaks = NULL
    ) +
    scale_colour_brewer(        
        type = "qual",           
        palette = "Set1"       
    ) +
    scale_size_continuous(       
        trans = "exp",          
        guide = "none"           
    ) +
    theme_linedraw() +           
    labs(                        
        x = "Valence",
        y = "Track Popularity",
        colour = "Mode"
    )
ggplotly(popularity)
```

***
This scatterplot clearly shows the track popularity, the valence, the loudness and the mode of the tracks. The track popularity is shown on the Y-axis, the X-axis shows the valence, the color of the dots shows the mode and the size of the dots shows the loudness. Since this is an interactive scatterplot, it is also easier to see which song has the highest popularity, valence or loudness and in which mode the song is written. What is very noticeable here is that the range of the track popularity of the most recent album (The Search For Everything) is much narrower compared to his first album (Room For Squares). What is also easily noticeable is that the first album has a much bigger outlier compared to the second album. However, even with these visuals, it still remains hard to find a real connection between the popularity, the valence, the mode or the loudness. That is why I also looked up the mean and standard deviation of nine different features that could be important for the popularity of the albums. 

| Room For Squares          | Mean    | Standard Deviation  |
| --------------------------|---------|---------------------|
| Danceability              | 0.609   |       0.0637        | 
| Energy                    | 0.676   |       0.130         | 
| Valence                   | 0.476   |       0.167         | 
| Mode                      | 0.769   |       0.439         |
| Key                       | 4.08    |       2.56          | 
| Tempo                     | 106.    |       20.9          | 
| Instrumentalness          | 0.00818 |       0.0158        | 
| Speechiness               | 0.0283  |       0.00378       | 
| Track Popularity          | 53.5    |       9.79          |

| The Search For Everything | Mean    | Standard Deviation  |
| --------------------------|---------|---------------------|
| Danceability              | 0.642   |       0.141         | 
| Energy                    | 0.465   |       0.167         | 
| Valence                   | 0.498   |       0.226         | 
| Mode                      | 0.833   |       0.389         |
| Key                       | 5.67    |       3.37          | 
| Tempo                     | 126.    |       32.3          | 
| Instrumentalness          | 0.0836  |       0.268         | 
| Speechiness               | 0.0338  |       0.0121        | 
| Track Popularity          | 60.9     |       3.32          |

It can be noticed that there are some differences between these two playlists. The first difference is the energy level. The energy level seems higher for the Room For Squares album. The second difference is the tempo, which seems to be higher for the most recent album, The Search For Everything. The third noticeable difference is that the instrumentalness is higher for the The Search For Everything album. The last, and for this corpus probably the most important difference is that the track popularity is higher for The Search For Everything. This shows that, even though the most popular song is on the Room For Squares album, The Search For Everything seems to have an overall higer popularity.  


-----------------------------------------------------------------------

### Most hits are on the album Continuum

```{r}
RoomForSquares <- get_playlist_audio_features('RoomForSquares', '5KTfoZbvQXBqDOn1gp2o3m')
TheSearchForEverything <- get_playlist_audio_features('TheSearchForEverything', '1y61rCSfD47QmYV3m6xKxA')
HeavierThings <- get_playlist_audio_features('HeavierThings', '2KNbRm1QgRJ2MaO5ZX0I5l')
Continuum <- get_playlist_audio_features('Continuum', '0YzeNYZYNeM7v3bO07ap58')
BattleStudies <- get_playlist_audio_features('BattleStudies', '4A49OLAtcHUxG9ewjZoxf2')
BornAndRaised <- get_playlist_audio_features('BornAndRaised', '119gpzzZIkDRzUpCLBUPXw')
ParadiseValley <- get_playlist_audio_features('ParadiseValley', '62TFD2OErZeHpmpTQdRstR')

JMAlbums <-
  RoomForSquares %>% mutate(playlist = "Room For Squares (2001)") %>%
  bind_rows(HeavierThings %>% mutate(playlist = "Heavier Things (2003)")) %>%
  bind_rows(Continuum %>% mutate(playlist = "Continuum (2006)")) %>%
  bind_rows(BattleStudies %>% mutate(playlist = "Battle Studies (2009)")) %>%
  bind_rows(BornAndRaised %>% mutate(playlist = "Born And Raised (2012)")) %>%
  bind_rows(ParadiseValley %>% mutate(playlist = "Paradise Valley (2013)")) %>%
  bind_rows(TheSearchForEverything %>% mutate(playlist = "The Search For Everything (2017)")) %>%
   mutate(playlist = fct_relevel(playlist, 'Room For Squares (2001)', 'Heavier Things (2003)', 'Continuum (2006)', 'Battle Studies (2009)', 'Born And Raised (2012)', 'Paradise Valley (2013)', 'The Search For Everything (2017)'))
   
Albums <- JMAlbums %>% ggplot(aes(x = playlist, y = track.popularity)) + 
            geom_boxplot() + 
            labs(title = "Popularity of John Mayer Albums",
                 x = "Album", y = "Track Popularity")
ggplotly(Albums)
```

***

These boxplots show the popularity of every John Mayer album. These boxplots show that the albums "Continuum" and "The Search for Everything" seem to contain the most popular tracks. However, it also shows that Continuum contains slightly more popular tracks than The Search for Everything, which is why, according to these boxplots, it can be said that Continuum is the most popular John Mayer album. This album is from the year 2006, which would mean that his older music is more popular than his newer music, however I do think that the success of this album does not have much to do with the oldness or newness, but more with the guitar skills in the tracks of this album.


-----------------------------------------------------------------------

### The biggest outlier is the track "Your Body Is a Wonderland"

```{r}
  JMALbums <-
  RoomForSquares %>% mutate(playlist = "Room For Squares (2001)") %>%
  bind_rows(HeavierThings %>% mutate(playlist = "Heavier Things (2003)")) %>%
  bind_rows(Continuum %>% mutate(playlist = "Continuum (2006)")) %>%
  bind_rows(BattleStudies %>% mutate(playlist = "Battle Studies (2009)")) %>%
  bind_rows(BornAndRaised %>% mutate(playlist = "Born And Raised (2012)")) %>%
  bind_rows(ParadiseValley %>% mutate(playlist = "Paradise Valley (2013)")) %>%
  bind_rows(TheSearchForEverything %>% mutate(playlist = "The Search For Everything (2017)")) %>% 
  mutate(playlist = fct_relevel(playlist, 'Room For Squares (2001)', 'Heavier Things (2003)', 'Continuum (2006)', 'Battle Studies (2009)', 'Born And Raised (2012)', 'Paradise Valley (2013)', 'The Search For Everything (2017)'))
popularity <-
  JMALbums %>% 
  mutate(                      
    mode =                  
      factor(
        mode, 
        c(1, 0), 
        c("Major", "Minor")
      )
  ) %>% 
  ggplot(                      
    aes(
      x = valence,
      y = track.popularity,
      size = energy,
      colour = playlist,
      label = track.name  
    )
  ) +
  geom_point() +               
  geom_rug(size = 0.1) +       
  scale_x_continuous(          
    limits = c(0, 1),
    breaks = c(0, 0.25, 0.50, 0.75, 1),  
    minor_breaks = NULL      
  ) +
  scale_y_continuous(          
    limits = c(40, 80),
    breaks = c(40, 45, 50, 55, 60, 65, 70, 75, 80),
    minor_breaks = NULL
  ) +
  scale_colour_brewer(         
    type = "qual",          
    palette = "Set1"       
  ) +
  scale_radius( 
    range = c(1,4), 
    trans = "exp",           
    guide = "none"          
  ) +
  theme_linedraw() +           
  labs(                        
    title = "Popularity, valence and energy of John Mayer Albums",
    x = "Valence",
    y = "Track Popularity",
    colour = "Album"
  ) 
ggplotly(popularity)
```

***
This interactive scatterplot clearly shows all of the albums in different colors. Because of the different colors it is easy to see which albums seem to be more popular and which album contains most outliers for example. In this scatterplot, the valence is shown on the x-axis and the track popularity is shown on the y-axis. The size of the dots in this scatterplot shows the energy. In this interactive scatterplot it can easily be seen that the biggest outlier (mostly in popularity) is the track "Your Body Is a Wonderland" of the album Room For Squares, which also is the oldest album in the scatterplot. The other three ouliers, however, are the tracks "Slow Dancing In A Burning Room", "Gravity", and "Waiting On the World to Change", which are all on the album Continuum. Even though, these seem to be the most popular tracks, it does not show much about the valence or loudness for example. It seems that there is no real connection between the track popularity and the valence and/or energy.

-----------------------------------------------------------------------


### The most popular album is Continuum

From these visualisations it seems that, even though the biggest outlier is on the Room For Squares album, the Continuum album is the most popular album out of all John Mayer albums. However, it is still uncertain why this is the most popular album. The results of the valence and energy levels, unfortunately, do not show why this album seems to be the most popular. There are not really noticeable differences in valence or energy in the tracks of this album, compared to the tracks of other albums. However, I think that the high popularity of this album is mostly due to the great guitar skills and the guitarsolos. But unfortunately, this remains unknown.
